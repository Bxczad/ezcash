import asyncio
from telethon import TelegramClient, events
import re
import traceback

# –î–∞–Ω–Ω—ã–µ –∏–∑ config.py
API_ID = 27260384
API_HASH = "62a7718d034246389f4046f6c180196d"
PHONE_NUMBER = "+79826160910"

# –¢–æ–∫–µ–Ω –±–æ—Ç–∞
BOT_TOKEN = "7632181128:AAE5m1jyQOksN8_ifijMbMaJb48PObLsbdo"  # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à —Ç–æ–∫–µ–Ω –±–æ—Ç–∞

# ID –∏–ª–∏ —é–∑–µ—Ä–Ω–µ–π–º –∫–∞–Ω–∞–ª–∞, –∫—É–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥—ã
TARGET_CHANNEL = "@terixpromo"  # –ö–∞–Ω–∞–ª, –∫—É–¥–∞ –±—É–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å—Å—è –ø—Ä–æ–º–æ–∫–æ–¥—ã

# –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ–ª–Ω—ã—Ö –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤
PROMO_REGEX = r"EZ-[A-Z0-9]{6}-SH"  # –§–æ—Ä–º–∞—Ç –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤: EZ-<6 —Å–∏–º–≤–æ–ª–æ–≤>-SH

# –°–ø–∏—Å–æ–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤
sent_promo_codes = []

# –ö–ª–∏–µ–Ω—Ç –¥–ª—è –≤–∞—à–µ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞
user_client = TelegramClient("user_session", API_ID, API_HASH)

# –ö–ª–∏–µ–Ω—Ç –¥–ª—è –±–æ—Ç–∞ (—Å API_ID –∏ API_HASH)
bot_client = TelegramClient("bot_session", API_ID, API_HASH)

# –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ —á–µ—Ä–µ–∑ –±–æ—Ç–∞
async def send_promo_code(code):
    if code not in sent_promo_codes:
        try:
            print(f"–û—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–æ–º–æ–∫–æ–¥–∞: {code}")  # –õ–æ–≥–∏—Ä—É–µ–º –ø—Ä–æ–º–æ–∫–æ–¥ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
            # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –Ω—É–∂–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
            message = f"`EZ-{code[3:-3]}-SH`\nüëâ https://ezc.sh/terix"  # –ü—Ä–æ–º–æ–∫–æ–¥ –∏ —Å—Å—ã–ª–∫–∞
            await bot_client.send_message(TARGET_CHANNEL, message, parse_mode="md")
            print(f"–ü—Ä–æ–º–æ–∫–æ–¥ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω: {code}")
            sent_promo_codes.append(code)
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞ {code}: {e}")
            traceback.print_exc()

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ –≤—Å–µ—Ö –∫–∞–Ω–∞–ª–æ–≤
@user_client.on(events.NewMessage(incoming=True))
async def handle_new_message(event):
    try:
        if event.is_channel and event.raw_text:
            promo_codes = re.findall(PROMO_REGEX, event.raw_text)  # –ò—â–µ–º –ø–æ–ª–Ω—ã–µ –ø—Ä–æ–º–æ–∫–æ–¥—ã
            for code in promo_codes:
                await send_promo_code(code)
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")
        traceback.print_exc()

# –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ –≤—Å–µ—Ö –∫–∞–Ω–∞–ª–æ–≤
@user_client.on(events.MessageEdited(incoming=True))
async def handle_edited_message(event):
    try:
        if event.is_channel and event.raw_text:
            promo_codes = re.findall(PROMO_REGEX, event.raw_text)  # –ò—â–µ–º –ø–æ–ª–Ω—ã–µ –ø—Ä–æ–º–æ–∫–æ–¥—ã
            for code in promo_codes:
                await send_promo_code(code)
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")
        traceback.print_exc()

# –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö —Å–µ—Å—Å–∏–∏
async def reconnect():
    while True:
        try:
            print("–ü—Ä–æ—Ü–µ—Å—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞...")
            await user_client.start(phone=PHONE_NUMBER)
            print("user_client —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω!")
            await bot_client.start(bot_token=BOT_TOKEN)
            print("bot_client —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω!")
            break
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏: {e}")
            traceback.print_exc()
            await asyncio.sleep(15)

# –ó–∞–ø—É—Å–∫ –∫–ª–∏–µ–Ω—Ç–∞
print("–°–∫—Ä–∏–ø—Ç –∑–∞–ø—É—â–µ–Ω. –ß—Ç–µ–Ω–∏–µ –≤—Å–µ—Ö –∫–∞–Ω–∞–ª–æ–≤, –≥–¥–µ –µ—Å—Ç—å –≤–∞—à –∞–∫–∫–∞—É–Ω—Ç...")
async def main():
    await reconnect()
    await user_client.run_until_disconnected()

# –ó–∞–ø—É—Å–∫ –ø—Ä–æ–≥—Ä–∞–º–º—ã
if __name__ == "__main__":
    asyncio.run(main())
